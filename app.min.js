const CONFIG={N8N_WEBHOOK_URL:"https://dundeefounders.app.n8n.cloud/webhook/charades-topic"};let gameState={timerLength:60,totalRounds:3,theme:"",players:[],currentRound:1,currentPlayerIndex:0,usedTopics:[],timerInterval:null,currentTopic:null,currentCategory:null};function showScreen(e){document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("active")}),document.getElementById(e).classList.add("active")}function showElement(e){document.getElementById(e).classList.remove("hidden")}function hideElement(e){document.getElementById(e).classList.add("hidden")}let tempPhoto=null,webcamStream=null;function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window}async function openWebcam(){document.getElementById("webcam-modal");const e=document.getElementById("webcam-video");try{webcamStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"},audio:!1}),e.srcObject=webcamStream,showElement("webcam-modal")}catch(e){console.error("Error accessing webcam:",e),alert("Could not access webcam. Please check your camera permissions.")}}function closeWebcam(){document.getElementById("webcam-modal");const e=document.getElementById("webcam-video");webcamStream&&(webcamStream.getTracks().forEach(e=>e.stop()),webcamStream=null),e.srcObject=null,hideElement("webcam-modal")}function updatePlayersGrid(){const e=document.getElementById("players-list");e.innerHTML="",gameState.players.forEach((t,o)=>{const n=document.createElement("div");n.className="player-card",n.innerHTML=`\n            <div class="player-card-photo">\n                ${t.photo?`<img src="${t.photo}" alt="${t.name}">`:"ğŸ­"}\n            </div>\n            <div class="player-card-name">${t.name}</div>\n            <button class="remove-player" onclick="removePlayer(${o})">Ã—</button>\n        `,e.appendChild(n)})}function removePlayer(e){gameState.players.splice(e,1),updatePlayersGrid(),updateStartButton()}function updateStartButton(){const e=document.getElementById("start-game-btn");gameState.players.length>=2?(e.disabled=!1,e.textContent=`Start Game (${gameState.players.length} players)`):(e.disabled=!0,e.textContent="Start Game (need 2+ players)")}function showGameScreen(){showScreen("game-screen"),displayCurrentPlayer(),updateRoundIndicator(),hideElement("timer-container"),hideElement("topic-container"),hideElement("turn-actions-section"),hideElement("guesser-section"),showElement("start-turn-section")}function displayCurrentPlayer(){const e=gameState.players[gameState.currentPlayerIndex],t=document.getElementById("current-player-photo");e.photo?t.innerHTML=`<img src="${e.photo}" alt="${e.name}">`:t.innerHTML="<span>ğŸ­</span>",document.getElementById("current-player-name").textContent=e.name}function updateRoundIndicator(){const e=`Round ${gameState.currentRound} of ${gameState.totalRounds}`;document.getElementById("round-indicator").textContent=e,document.getElementById("leaderboard-round").textContent=e}async function getTopicFromAI(){const e=await fetch(CONFIG.N8N_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({usedTopics:gameState.usedTopics,theme:gameState.theme})});if(!e.ok)throw new Error("API request failed");return await e.json()}function useFallbackTopic(){const e=[{category:"Movie",emoji:"ğŸ¬",topic:"Home Alone"},{category:"Movie",emoji:"ğŸ¬",topic:"The Wizard of Oz"},{category:"Movie",emoji:"ğŸ¬",topic:"Jaws"},{category:"Movie",emoji:"ğŸ¬",topic:"Titanic"},{category:"Movie",emoji:"ğŸ¬",topic:"Star Wars"},{category:"Movie",emoji:"ğŸ¬",topic:"The Lion King"},{category:"Movie",emoji:"ğŸ¬",topic:"Frozen"},{category:"Movie",emoji:"ğŸ¬",topic:"Jurassic Park"},{category:"Movie",emoji:"ğŸ¬",topic:"The Godfather"},{category:"Movie",emoji:"ğŸ¬",topic:"Elf"},{category:"Movie",emoji:"ğŸ¬",topic:"The Grinch"},{category:"Movie",emoji:"ğŸ¬",topic:"Mary Poppins"},{category:"Movie",emoji:"ğŸ¬",topic:"Finding Nemo"},{category:"Movie",emoji:"ğŸ¬",topic:"Shrek"},{category:"Movie",emoji:"ğŸ¬",topic:"Harry Potter"},{category:"Movie",emoji:"ğŸ¬",topic:"Back to the Future"},{category:"Movie",emoji:"ğŸ¬",topic:"The Matrix"},{category:"Movie",emoji:"ğŸ¬",topic:"Toy Story"},{category:"Movie",emoji:"ğŸ¬",topic:"E.T."},{category:"Movie",emoji:"ğŸ¬",topic:"Ghostbusters"},{category:"Movie",emoji:"ğŸ¬",topic:"Indiana Jones"},{category:"Movie",emoji:"ğŸ¬",topic:"The Sound of Music"},{category:"Movie",emoji:"ğŸ¬",topic:"Forrest Gump"},{category:"Movie",emoji:"ğŸ¬",topic:"The Breakfast Club"},{category:"Movie",emoji:"ğŸ¬",topic:"Die Hard"},{category:"Movie",emoji:"ğŸ¬",topic:"Rocky"},{category:"Movie",emoji:"ğŸ¬",topic:"Grease"},{category:"Movie",emoji:"ğŸ¬",topic:"Dirty Dancing"},{category:"Movie",emoji:"ğŸ¬",topic:"The Notebook"},{category:"Movie",emoji:"ğŸ¬",topic:"Gladiator"},{category:"TV Show",emoji:"ğŸ“º",topic:"Friends"},{category:"TV Show",emoji:"ğŸ“º",topic:"The Simpsons"},{category:"TV Show",emoji:"ğŸ“º",topic:"Game of Thrones"},{category:"TV Show",emoji:"ğŸ“º",topic:"Breaking Bad"},{category:"TV Show",emoji:"ğŸ“º",topic:"The Office"},{category:"TV Show",emoji:"ğŸ“º",topic:"Doctor Who"},{category:"TV Show",emoji:"ğŸ“º",topic:"Stranger Things"},{category:"TV Show",emoji:"ğŸ“º",topic:"The Crown"},{category:"TV Show",emoji:"ğŸ“º",topic:"Downton Abbey"},{category:"TV Show",emoji:"ğŸ“º",topic:"Sherlock"},{category:"TV Show",emoji:"ğŸ“º",topic:"Big Bang Theory"},{category:"TV Show",emoji:"ğŸ“º",topic:"Seinfeld"},{category:"TV Show",emoji:"ğŸ“º",topic:"The Sopranos"},{category:"TV Show",emoji:"ğŸ“º",topic:"Peaky Blinders"},{category:"TV Show",emoji:"ğŸ“º",topic:"Black Mirror"},{category:"TV Show",emoji:"ğŸ“º",topic:"The X Files"},{category:"TV Show",emoji:"ğŸ“º",topic:"Fawlty Towers"},{category:"TV Show",emoji:"ğŸ“º",topic:"Only Fools and Horses"},{category:"TV Show",emoji:"ğŸ“º",topic:"Strictly Come Dancing"},{category:"TV Show",emoji:"ğŸ“º",topic:"Great British Bake Off"},{category:"Song",emoji:"ğŸµ",topic:"Jingle Bells"},{category:"Song",emoji:"ğŸµ",topic:"Bohemian Rhapsody"},{category:"Song",emoji:"ğŸµ",topic:"Yesterday"},{category:"Song",emoji:"ğŸµ",topic:"Imagine"},{category:"Song",emoji:"ğŸµ",topic:"Like a Rolling Stone"},{category:"Song",emoji:"ğŸµ",topic:"Sweet Child O Mine"},{category:"Song",emoji:"ğŸµ",topic:"Billie Jean"},{category:"Song",emoji:"ğŸµ",topic:"Wonderwall"},{category:"Song",emoji:"ğŸµ",topic:"Hey Jude"},{category:"Song",emoji:"ğŸµ",topic:"Smells Like Teen Spirit"},{category:"Song",emoji:"ğŸµ",topic:"Hotel California"},{category:"Song",emoji:"ğŸµ",topic:"Stairway to Heaven"},{category:"Song",emoji:"ğŸµ",topic:"All I Want for Christmas"},{category:"Song",emoji:"ğŸµ",topic:"Let It Be"},{category:"Song",emoji:"ğŸµ",topic:"Rocket Man"},{category:"Song",emoji:"ğŸµ",topic:"Dancing Queen"},{category:"Song",emoji:"ğŸµ",topic:"Born to Run"},{category:"Song",emoji:"ğŸµ",topic:"Purple Rain"},{category:"Song",emoji:"ğŸµ",topic:"Thriller"},{category:"Song",emoji:"ğŸµ",topic:"Fairytale of New York"},{category:"Book",emoji:"ğŸ“š",topic:"Harry Potter"},{category:"Book",emoji:"ğŸ“š",topic:"The Hobbit"},{category:"Book",emoji:"ğŸ“š",topic:"Pride and Prejudice"},{category:"Book",emoji:"ğŸ“š",topic:"To Kill a Mockingbird"},{category:"Book",emoji:"ğŸ“š",topic:"The Great Gatsby"},{category:"Book",emoji:"ğŸ“š",topic:"The Catcher in the Rye"},{category:"Book",emoji:"ğŸ“š",topic:"Lord of the Rings"},{category:"Book",emoji:"ğŸ“š",topic:"A Christmas Carol"},{category:"Book",emoji:"ğŸ“š",topic:"Winnie the Pooh"},{category:"Book",emoji:"ğŸ“š",topic:"Alice in Wonderland"},{category:"Book",emoji:"ğŸ“š",topic:"The Da Vinci Code"},{category:"Book",emoji:"ğŸ“š",topic:"Gone Girl"},{category:"Book",emoji:"ğŸ“š",topic:"The Hunger Games"},{category:"Book",emoji:"ğŸ“š",topic:"Charlotte's Web"},{category:"Book",emoji:"ğŸ“š",topic:"Charlie and the Chocolate Factory"},{category:"Famous Person",emoji:"â­",topic:"Elvis Presley"},{category:"Famous Person",emoji:"â­",topic:"Marilyn Monroe"},{category:"Famous Person",emoji:"â­",topic:"The Queen"},{category:"Famous Person",emoji:"â­",topic:"David Beckham"},{category:"Famous Person",emoji:"â­",topic:"BeyoncÃ©"},{category:"Famous Person",emoji:"â­",topic:"Michael Jackson"},{category:"Famous Person",emoji:"â­",topic:"Madonna"},{category:"Famous Person",emoji:"â­",topic:"Charlie Chaplin"},{category:"Famous Person",emoji:"â­",topic:"Winston Churchill"},{category:"Famous Person",emoji:"â­",topic:"William Shakespeare"},{category:"Famous Person",emoji:"â­",topic:"Albert Einstein"},{category:"Famous Person",emoji:"â­",topic:"Barack Obama"},{category:"Famous Person",emoji:"â­",topic:"James Bond"},{category:"Famous Person",emoji:"â­",topic:"Santa Claus"},{category:"Famous Person",emoji:"â­",topic:"Harry Styles"}],t=e.filter(e=>!gameState.usedTopics.includes(e.topic)),o=t.length>0?t[Math.floor(Math.random()*t.length)]:e[Math.floor(Math.random()*e.length)];gameState.currentTopic=o.topic,gameState.currentCategory=o.category,gameState.usedTopics.push(o.topic),document.getElementById("category-badge").textContent=`${o.emoji} ${o.category}`,document.getElementById("topic-text").textContent=o.topic;const n=gameState.players[gameState.currentPlayerIndex],a=document.getElementById("skip-btn");n.skipsLeft>0?(document.getElementById("skip-text").textContent=`Skip (${n.skipsLeft} left)`,a.disabled=!1):(document.getElementById("skip-text").textContent="No skips left",a.disabled=!0),showElement("topic-container"),setTimeout(()=>{startCountdown()},2e3)}function startCountdown(){showElement("countdown-container");const e=document.getElementById("countdown-display");let t=3;e.textContent=t;const o=setInterval(()=>{t--,t>0?(e.textContent=t,e.style.animation="none",setTimeout(()=>{e.style.animation=""},10)):0===t?(e.textContent="GO!",e.style.animation="none",setTimeout(()=>{e.style.animation=""},10)):(clearInterval(o),hideElement("countdown-container"),hideElement("topic-container"),showElement("peek-section"),showElement("turn-actions-section"),startTimer())},1e3)}function startTimer(){let e=gameState.timerLength;const t=document.getElementById("timer-display");t.textContent=e,t.classList.remove("warning","danger"),showElement("timer-container"),gameState.timerInterval=setInterval(()=>{e--,t.textContent=e,e<=5?t.classList.add("danger"):e<=10&&t.classList.add("warning"),e<=0&&(stopTimer(),handleFail())},1e3)}function stopTimer(){gameState.timerInterval&&(clearInterval(gameState.timerInterval),gameState.timerInterval=null)}document.getElementById("photo-preview").addEventListener("click",()=>{isMobileDevice()?document.getElementById("photo-input").click():openWebcam()}),document.getElementById("photo-input").addEventListener("change",e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{tempPhoto=e.target.result;document.getElementById("photo-preview").innerHTML=`<img src="${tempPhoto}" alt="Preview">`},e.readAsDataURL(t)}}),document.getElementById("capture-photo-btn").addEventListener("click",()=>{const e=document.getElementById("webcam-video"),t=document.getElementById("webcam-canvas"),o=t.getContext("2d");t.width=e.videoWidth,t.height=e.videoHeight,o.drawImage(e,0,0,t.width,t.height),tempPhoto=t.toDataURL("image/jpeg",.8);document.getElementById("photo-preview").innerHTML=`<img src="${tempPhoto}" alt="Preview">`,closeWebcam()}),document.getElementById("cancel-webcam-btn").addEventListener("click",()=>{closeWebcam()}),document.getElementById("add-player-btn").addEventListener("click",()=>{const e=document.getElementById("player-name-input"),t=e.value.trim();t?gameState.players.find(e=>e.name===t)?alert("Someone with that name is already playing!"):(gameState.players.push({name:t,photo:tempPhoto||null,score:0,skipsLeft:1}),e.value="",tempPhoto=null,document.getElementById("photo-preview").innerHTML='<span class="photo-placeholder">ğŸ“¸</span>',updatePlayersGrid(),updateStartButton()):alert("Please enter a player name")}),document.getElementById("timer-setting").addEventListener("change",e=>{gameState.timerLength=parseInt(e.target.value)}),document.getElementById("rounds-setting").addEventListener("change",e=>{gameState.totalRounds=parseInt(e.target.value)}),document.getElementById("theme-setting").addEventListener("input",e=>{gameState.theme=e.target.value.trim()}),document.getElementById("start-game-btn").addEventListener("click",()=>{gameState.players.sort(()=>Math.random()-.5),gameState.players.forEach(e=>e.skipsLeft=1),gameState.currentRound=1,gameState.currentPlayerIndex=0,gameState.usedTopics=[],showGameScreen()}),document.getElementById("start-turn-btn").addEventListener("click",async()=>{hideElement("start-turn-section"),showElement("loading");try{const e=await getTopicFromAI();if(e){gameState.currentTopic=e.topic,gameState.currentCategory=e.category,gameState.usedTopics.push(e.topic),document.getElementById("category-badge").textContent=`${e.emoji} ${e.category}`,document.getElementById("topic-text").textContent=e.topic,hideElement("loading"),showElement("topic-container");const t=gameState.players[gameState.currentPlayerIndex],o=document.getElementById("skip-btn");t.skipsLeft>0?(document.getElementById("skip-text").textContent=`Skip (${t.skipsLeft} left)`,o.disabled=!1):(document.getElementById("skip-text").textContent="No skips left",o.disabled=!0),setTimeout(()=>{startCountdown()},2e3)}else hideElement("loading"),useFallbackTopic()}catch(e){hideElement("loading"),console.log("Using fallback topics (AI not connected)"),useFallbackTopic()}});const peekBtn=document.getElementById("peek-btn");function handleFail(){stopTimer(),nextTurn()}function showGuesserSelection(){const e=document.getElementById("guesser-list");e.innerHTML="",gameState.players.forEach((t,o)=>{if(o===gameState.currentPlayerIndex)return;const n=document.createElement("button");n.className="guesser-btn";const a=t.photo?`<img src="${t.photo}" alt="${t.name}">`:'<div class="guesser-btn-photo">ğŸ­</div>';n.innerHTML=`${a}<span>${t.name}</span>`,n.addEventListener("click",()=>{t.score++,showPointsNotification(),setTimeout(()=>{nextTurn()},500)}),e.appendChild(n)}),showElement("guesser-section")}function nextTurn(){hideElement("guesser-section"),hideElement("turn-actions-section"),hideElement("topic-container"),hideElement("timer-container"),hideElement("peek-section"),hideElement("countdown-container"),gameState.currentPlayerIndex++,gameState.currentPlayerIndex>=gameState.players.length&&(gameState.currentPlayerIndex=0,gameState.currentRound++,gameState.players.forEach(e=>e.skipsLeft=1),gameState.currentRound>gameState.totalRounds)?showGameOver():showGameScreen()}function showLeaderboard(){showScreen("leaderboard-screen"),updateRoundIndicator();const e=document.getElementById("leaderboard-list");e.innerHTML="";[...gameState.players].sort((e,t)=>t.score-e.score).forEach((t,o)=>{const n=document.createElement("div");n.className="leaderboard-item",0===o&&n.classList.add("winner");const a=t.photo?`<img src="${t.photo}" alt="${t.name}">`:"ğŸ­";n.innerHTML=`\n            <div class="leaderboard-rank">${0===o?"ğŸ†":o+1}</div>\n            <div class="leaderboard-photo">${a}</div>\n            <div class="leaderboard-info">\n                <div class="leaderboard-name">${t.name}</div>\n                <div class="leaderboard-score">${t.score} pts</div>\n            </div>\n        `,e.appendChild(n)})}function showGameOver(){showScreen("game-over-screen");const e=[...gameState.players].sort((e,t)=>t.score-e.score),t=e[0];document.getElementById("winner-announcement").innerHTML=`\n        <h2>ğŸ‰ ${t.name} Wins! ğŸ‰</h2>\n        <p style="font-size: 1.3rem; font-weight: bold;">${t.score} points</p>\n    `;const o=document.getElementById("final-leaderboard");o.innerHTML="",e.forEach((e,t)=>{const n=document.createElement("div");n.className="leaderboard-item",0===t&&n.classList.add("winner");const a=e.photo?`<img src="${e.photo}" alt="${e.name}">`:"ğŸ­";n.innerHTML=`\n            <div class="leaderboard-rank">${0===t?"ğŸ†":t+1}</div>\n            <div class="leaderboard-photo">${a}</div>\n            <div class="leaderboard-info">\n                <div class="leaderboard-name">${e.name}</div>\n                <div class="leaderboard-score">${e.score} pts</div>\n            </div>\n        `,o.appendChild(n)})}function showPointsNotification(){const e=document.getElementById("points-notification");e.classList.remove("show"),e.offsetWidth,e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}peekBtn.addEventListener("mousedown",()=>{showElement("topic-container")}),peekBtn.addEventListener("mouseup",()=>{hideElement("topic-container")}),peekBtn.addEventListener("mouseleave",()=>{hideElement("topic-container")}),peekBtn.addEventListener("touchstart",e=>{e.preventDefault(),showElement("topic-container")}),peekBtn.addEventListener("touchend",e=>{e.preventDefault(),hideElement("topic-container")}),document.getElementById("skip-btn").addEventListener("click",async()=>{const e=gameState.players[gameState.currentPlayerIndex];if(e.skipsLeft>0){e.skipsLeft--,stopTimer(),hideElement("topic-container"),hideElement("turn-actions-section"),hideElement("timer-container"),hideElement("peek-section"),showElement("loading");try{const t=await getTopicFromAI();t?(gameState.currentTopic=t.topic,gameState.currentCategory=t.category,gameState.usedTopics.push(t.topic),document.getElementById("category-badge").textContent=`${t.emoji} ${t.category}`,document.getElementById("topic-text").textContent=t.topic,hideElement("loading"),showElement("topic-container"),document.getElementById("skip-text").textContent=e.skipsLeft>0?`Skip (${e.skipsLeft} left)`:"No skips left",document.getElementById("skip-btn").disabled=0===e.skipsLeft,setTimeout(()=>{startCountdown()},2e3)):useFallbackTopic()}catch(e){hideElement("loading"),useFallbackTopic()}}}),document.getElementById("success-btn").addEventListener("click",()=>{stopTimer(),hideElement("turn-actions-section"),showGuesserSelection()}),document.getElementById("fail-btn").addEventListener("click",()=>{handleFail()}),document.getElementById("view-leaderboard-btn").addEventListener("click",()=>{showLeaderboard()}),document.getElementById("back-to-game-btn").addEventListener("click",()=>{showGameScreen()}),document.getElementById("new-game-btn").addEventListener("click",()=>{gameState.players.forEach(e=>{e.score=0,e.skipsLeft=1}),gameState.currentRound=1,gameState.currentPlayerIndex=0,gameState.usedTopics=[],showScreen("setup-screen")}),"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(e=>console.log("Service Worker registered")).catch(e=>console.error("Service Worker registration failed:",e));